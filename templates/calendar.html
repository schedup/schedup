{% extends "layout.html" %}

<!-- {% block header %} -->
<!-- {{title}} -->
<!-- {% endblock %} -->
{% block topbar %}
<div class="ui-bar ui-bar-b">
	<a href="#sidepanel" data-role="button" class="ui-icon-nodisc" data-icon="bars" data-iconpos="notext" data-theme="b" data-iconshadow="false" data-ajax=false data-inline="true"></a>
	<a href="info#" data-role="button" class="ui-icon-nodisc" data-icon="info" data-iconpos="notext" data-theme="b" data-iconshadow="false" data-ajax=false data-inline="true"></a>
	<a href="#" data-role="button" class="ui-icon-nodisc" data-icon="plus" data-iconpos="notext" data-theme="b" data-iconshadow="false" data-ajax=false data-inline="true"></a>
	<h1 class="ui-title" role="heading" aria-level="1">SchedUp</h1>
	<div style="float:right;">
		 <a href="/" data-role="button" class="ui-icon-nodisc" data-icon="home" data-iconpos="notext" data-theme="b" data-iconshadow="false" data-ajax=false data-inline="true"></a>
    </div>
</div>
{% endblock %} 

{% block content %}

<div class="calendar-container">
<div id="calendar-grid" class="disable-select">
<div class="calendar-days">
    <div class="calendar-day-cell calendar-day-cell-x"></div>
    {% for day, dayname in days %}
        <div class="calendar-day-cell {% if dayname == 'Fr' or dayname == 'Sa' %}day-weekend{%endif%}">
        {{day}} [{{dayname}}]</div>
    {% endfor %}
</div>
{% for hour in hours %}
    <div class="calendar-row">
	    <div class="calendar-hour">{{hour}}</div>
	    {% for day, _ in days %}
	        <div class="calendar-cell" id="cal-cell-{{day}}-{{hour}}" data-hour="{{day}},{{hour}}"></div>
	    {% endfor %}
    </div>
    <div class="calendar-row">
	    <div class="calendar-hour calendar-hour-half"></div>
	    {% for day, _ in days %}
	        <div class="calendar-cell calendar-cell-half" id="cal-cell-{{day}}-{{hour}}-half"
	        data-hour="{{day}},{{hour}}.5"></div>
	    {% endfor %}
    </div>
{% endfor %}
</div>
</div>

<p>
<button data-role="button" id="savebtn" data-theme="b" data-icon="check" data-iconpos="right">Send</button>
</p>

<script type="text/javascript">
$(document).ready(function(){
    
    var last_cell = null;
    
	/*$("#calendar-grid").on("vmousemove", function(e){
	    var elem = $(this);
	    var clickElem = $(document.elementFromPoint(e.pageX, e.pageY));
	    
	    if (e.which != 0 && clickElem.hasClass("calendar-cell")) {
		    if (last_cell != null && last_cell.attr("id") == clickElem.attr("id")) {
				return;
		    }
		    last_cell = clickElem;
			clickElem.toggleClass("calendar-cell-selected");
			e.preventDefault();
		}
	});*/
	
	$(".calendar-cell").on("click", function(e) {
	    $(this).toggleClass("calendar-cell-selected");
	});
	
	var events = {{events_json|safe}};
	
	var hoffset = $(".calendar-hour").outerWidth();
	var voffset = $(".calendar-days").outerHeight();
	var evtwidth = $(".calendar-cell").outerWidth();
	var evtheight = $(".calendar-cell").outerHeight() + $(".calendar-cell-half").outerHeight();

	var grid = $("#calendar-grid");
	
	if (events.length) {
		for (var i in events) {
			var evt = events[i];
			var evtdiv = $("<div class='calendar-event' id='calendar-event-" + evt.day + "-" + evt.hour + "'>");
			var title = $("<span class='calendar-event-title'>");
			title.text(evt.title);
			evtdiv.append(title);
			grid.append(evtdiv);
	        console.log(evt.hour, evt.day);
	        evtdiv.css("top", voffset + (evt.hour - {{min_hour}}) * evtheight);
	        evtdiv.css("left", hoffset + evt.day * evtwidth + 3);
	        evtdiv.css("height", evt.duration * evtheight - 3);
		}
	}

	var suggested = {{suggested_json|safe}};

	if (suggested.length) {
		for (var i in suggested) {
			var evt = suggested[i];
			var evtdiv = $("<div class='calendar-slot' id='calendar-slot-" + evt.day + "-" + evt.hour + "'>");
			var title = $("<span class='calendar-event-title'>");
			title.text("["+evt.going + "/" + evt.count + "]");
			evtdiv.append(title);
			grid.append(evtdiv);
	        console.log(evt.hour, evt.day);
	        evtdiv.css("top", voffset + (evt.hour - {{min_hour}}) * evtheight);
	        evtdiv.css("left", hoffset + evt.day * evtwidth + 3);
	        evtdiv.css("height", evt.duration * evtheight - 3);
		}
	}
	
	$("#savebtn").on("click", function(){
	    var selected = $.map($(".calendar-cell-selected"), function(elem){return $(elem).data("hour");});
	    console.log(selected);
	    
	    $.ajax("{{post_url}}", {
			cache : false,
			type: "POST",
			dataType : "json",
			data: JSON.stringify(selected),
			traditional: true,
			success : function(){
			    console.log("hurra");
			    window.location.href = "/my";
			},
			error : function(x){
			    console.log("oh nos", x);
			}

	    });
	});
	
});
</script>

{% endblock %}

