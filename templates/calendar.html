{% extends "layout.html" %}


{% block topbar %}
<link rel="stylesheet" href="path/to/font-awesome/css/font-awesome.min.css">

<!-- TOP BAR -->
<div class="ui-bar ui-bar-b">
	<a href="#sidepanel" data-role="button" class="ui-icon-nodisc" data-icon="bars" data-iconpos="notext" data-theme="b" data-iconshadow="false" data-ajax=false data-inline="true"></a>
	<a href="#transitionExample" data-transition="pop" data-icon="info" data-role="button" data-inline="true" data-rel="popup" class="ui-icon-nodisc"data-iconpos="notext"></a>
	<a href="#friendsFilter" data-transition="pop" data-icon="plus" data-role="button" data-inline="true" data-rel="popup" class="ui-icon-nodisc"data-iconpos="notext"></a>
	<h1 class="ui-title" role="heading" aria-level="1">SchedUp</h1>
	<a href="/" data-role="button" class="ui-icon-nodisc" data-icon="home" data-iconpos="notext" data-theme="b" data-iconshadow="false" data-ajax=false data-inline="true"></a>
</div>
<div data-role="popup" id="transitionExample" data-overlay-theme="a" class="ui-content" data-theme="d" data-position-to="window">
	<style>
	h2 { color:DodgerBlue ; width:200px; font-size:24px; }
  	</style>
  	<h2>{{event.title}}</h1>
	<h4>{{event.type}} Event</h4>
	<h4>By {{event.owner.get().fullname or event.owner.get().email}} </h4>
	{% if event.description %} 
	<h4>Description</h4>
	<p>{{event.description}}</p>
	{% endif %}
</div>

<div data-role="popup" id="friendsFilter" data-overlay-theme="a" class="ui-content" data-theme="d" data-position-to="window">
	<style>
	h2 { color:DodgerBlue ; width:200px; font-size:24px; }
  	</style>
  	<div data-role="fieldcontain">
	<div class="ui-controlgroup-controls">
		{% set i = 1 %}
		{% for guest in event.guests %}
			{% if guest.status == "accept" %}
        		{% set checkbox_name = "myCheckBox" %}
        	{% elif guest.status == "decline" %}
        		{% set checkbox_name = "declineCheckBox" %}
        	{% else %}
        		{% set checkbox_name = "pendingCheckBox" %}
        	{% endif %}
			{% set user = guest.user %}
        	{% if user %}
        		{% set display_name = user.get().fullname or user.get().email %}
        	{% else %}
        		{% set display_name = guest.email %}
        	{% endif %}
        {% set checkbox_id = "checkbox-"+i.__str__()+"a" %}
        {% set i = i+1 %}
        	<div class="ui-checkbox">
 				<input type="checkbox" name={{checkbox_name}} id={{checkbox_id}} class="custom">
 					<label for={{checkbox_id}} data-theme="c" class="ui-btn ui-btn-icon-left ui-corner-top ui-btn-up-c">
 						<span class="ui-btn-inner ui-corner-top">
 						<span class="ui-btn-text">{{display_name}}</span>
 						<span class="ui-icon ui-icon-ui-icon-checkbox-off ui-icon-checkbox-off"></span>
 						</span>
 					</label>
 			</div>
        {% endfor %}
	</div>
	</div>
</div>

{% endblock %} 

	
 		
{% block content %}

<div class="calendar-container">
<div id="calendar-grid" class="disable-select">
<div class="calendar-days">
    <div class="calendar-day-cell calendar-day-cell-x"></div>
    {% for day, dayname in days %}
        <div class="calendar-day-cell {% if dayname == 'Fr' or dayname == 'Sa' %}day-weekend{%endif%}">
        {{day}} [{{dayname}}]</div>
    {% endfor %}
</div>
{% for hour in hours %}
    <div class="calendar-row">
	    <div class="calendar-hour">{{hour}}</div>
	    {% for day, _ in days %}
	        <div class="calendar-cell" id="cal-cell-{{day}}-{{hour}}" data-hour="{{day}},{{hour}}"></div>
	    {% endfor %}
    </div>
    <div class="calendar-row">
	    <div class="calendar-hour calendar-hour-half"></div>
	    {% for day, _ in days %}
	        <div class="calendar-cell calendar-cell-half" id="cal-cell-{{day}}-{{hour}}-half"
	        data-hour="{{day}},{{hour}}.5"></div>
	    {% endfor %}
    </div>
{% endfor %}
</div>
</div>

<p>
<button data-role="button" id="savebtn" data-theme="b" data-icon="check" data-iconpos="right">Send</button>
</p>


<script type="text/javascript">

$(document).ready(function(){
    
    var last_cell = null;

    
	/*$("#calendar-grid").on("vmousemove", function(e){
	    var elem = $(this);
	    var clickElem = $(document.elementFromPoint(e.pageX, e.pageY));
	    
	    if (e.which != 0 && clickElem.hasClass("calendar-cell")) {
		    if (last_cell != null && last_cell.attr("id") == clickElem.attr("id")) {
				return;
		    }
		    last_cell = clickElem;
			clickElem.toggleClass("calendar-cell-selected");
			e.preventDefault();
		}
	});*/
	
// 	HANDLERS FOR FRIENDS FILTER
	$("input:checkbox[name=pendingCheckBox]").checkboxradio('disable');
	$("input:checkbox[name=declinedCheckBox]").checkboxradio('disable');
	$("#friendsFilter").on({
		   popupafterclose: function() {
 			   var selected = new Array();
 				$("input:checkbox[name=myCheckBox]:checked").each(function() {
 			       selected.push($(this));
 			  });
			  console.log(selected);
			  //highlight the votes of the friends requested by chekbox
		   }
	});
	
	$(".calendar-cell").on("click", function(e) {
	    $(this).toggleClass("calendar-cell-selected");
	});
	
	var events = {{events_json|safe}};
	
	var hoffset = $(".calendar-hour").outerWidth();
	var voffset = $(".calendar-days").outerHeight();
	var evtwidth = $(".calendar-cell").outerWidth();
	var evtheight = $(".calendar-cell").outerHeight() + $(".calendar-cell-half").outerHeight();

	var grid = $("#calendar-grid");
	
	if (events.length) {
		for (var i in events) {
			var evt = events[i];
			var evtdiv = $("<div class='calendar-event' id='calendar-event-" + evt.day + "-" + evt.hour + "'>");
			var title = $("<span class='calendar-event-title'>");
			title.text(evt.title);
			evtdiv.append(title);
			grid.append(evtdiv);
	        console.log(evt.hour, evt.day);
	        evtdiv.css("top", voffset + (evt.hour - {{min_hour}}) * evtheight);
	        evtdiv.css("left", hoffset + evt.day * evtwidth + 3);
	        evtdiv.css("height", evt.duration * evtheight - 3);
		}
	}

	var suggested = {{suggested_json|safe}};

	if (suggested.length) {
		for (var i in suggested) {
			var evt = suggested[i];
			var evtdiv = $("<div class='calendar-slot' id='calendar-slot-" + evt.day + "-" + evt.hour + "'>");
			var title = $("<span class='calendar-event-title'>");
			title.text("["+evt.going + "/" + evt.count + "]");
			evtdiv.append(title);
			grid.append(evtdiv);
	        console.log(evt.hour, evt.day);
	        evtdiv.css("top", voffset + (evt.hour - {{min_hour}}) * evtheight);
	        evtdiv.css("left", hoffset + evt.day * evtwidth + 3);
	        evtdiv.css("height", evt.duration * evtheight - 3);
		}
	}
	
	$("#savebtn").on("click", function(){
	    var selected = $.map($(".calendar-cell-selected"), function(elem){return $(elem).data("hour");});
	    console.log(selected);
	    
	    $.ajax("{{post_url}}", {
			cache : false,
			type: "POST",
			dataType : "json",
			data: JSON.stringify(selected),
			traditional: true,
			success : function(){
			    console.log("hurra");
			    window.location.href = "/my";
			},
			error : function(x){
			    console.log("oh nos", x);
			}

	    });
	});
	
});
</script>

{% endblock %}

