{% extends "layout.html" %}

{% block header %}
Edit Your Event
{% endblock %}

{% block content %}


<h1>{{event.title}}<a href="#editTitle" data-transition="pop" data-icon="edit" data-role="button" data-inline="true" data-rel="popup" data-theme="b" class="ui-icon-nodisc" data-iconpos="notext" title="Edit Title"></a></h1>
<!-- h4>By {{user.fullname or user.email}} </h4-->

<h4>From: {{event.start_time}}<a href="#editStartTime" data-transition="pop" data-icon="edit" data-role="button" data-inline="true" data-rel="popup" data-theme="b" class="ui-icon-nodisc" data-iconpos="notext" title="Edit Start Time"></a></h4>
<h4>To: {{event.end_time}}<a href="#editEndTime" data-transition="pop" data-icon="edit" data-role="button" data-inline="true" data-rel="popup" data-theme="b" class="ui-icon-nodisc" data-iconpos="notext" title="Edit End Time"></a></h4>
<!-- <h4> Event Type: {{event.type}}</h4> -->
<h4>Time Of Day: 
	{% set count = 0 %}
	{% for time in event.daytime %}
		{% set count = count + 1 %}
		{% if count == 1 %}
			{{time}} 
		{% else %}
			, {{time}}
		{% endif %}
	{% endfor %}<a href="#editTimeOfDay" data-transition="pop" data-icon="edit" data-role="button" data-inline="true" data-rel="popup" data-theme="b" class="ui-icon-nodisc" data-iconpos="notext" title="Edit Time Of Day"></a></h4>
<h4>Duration: {{event.duration/60}} Hours<a href="#editDuration" data-transition="pop" data-icon="edit" data-role="button" data-inline="true" data-rel="popup" data-theme="b" class="ui-icon-nodisc" data-iconpos="notext" title="Edit Duration"></a></h4>


{% if event.description %} 
<h4>Description<a href="#editDescription" data-transition="pop" data-icon="edit" data-role="button" data-inline="true" data-rel="popup" data-theme="b" class="ui-icon-nodisc" data-iconpos="notext" title="Edit Description"></a></h4>
<p style="padding-left: 50px;">{{event.description}}</p>
{% endif %}

<div data-role="collapsible-set" data-theme="c" data-content-theme="d">
    <div data-role="collapsible" data-collapsed="false">
        <h4>Guest List</h4>
        <!-- a href="#" data-role="button" data-icon="edit" data-iconpos="notext" title="Add guests"></a-->
        <ul data-role="listview" data-inset="true"
            {% if event.guests.__len__() > 10 %} data-filter="true" data-filter-placeholder="Search guest..." {%endif %}>
        {% for guest in event.guests %}
        	{% if guest.status == "accept" %}
        		{% set ic = "check" %}
        	{% elif guest.status == "decline" %}
        		{% set ic = "delete" %}
        	{% else %}
        		{% set ic = "false" %}
        	{% endif %}
        	{% set user = guest.user %}
        	{% if user %}
        		<li data-icon="{{ic}}" data-iconpos="left"><a href="#">{{user.get().fullname or user.get().email}}</a></li>
        	{% else %}
        		<li data-icon="{{ic}}" data-iconpos="left"><a href="#">{{guest.email}}</a></li>
        	{% endif %}
        {% endfor %}
        </ul>
    </div>
</div>

<a href="/cal/{{event.owner_token}}" data-role="button" data-theme="b" data-icon="arrow-r" data-iconpos="right" data-ajax="false">Check Votes</a>
<a href="/send/{{event.owner_token}}" data-theme="b" data-role="button" data-icon="check" data-iconpos="right" data-ajax="false">Send Invites</a>
<a href="/decline/{{event.owner_token}}" data-theme="c" data-role="button" data-icon="delete" data-iconpos="right" data-ajax="false">Cancel Event</a>

<div data-role="popup" id="editTitle" data-overlay-theme="a" class="ui-content" data-theme="d" data-position-to="window">
	<form action="{{post_url}}" method="post" data-ajax="false" id="titleform">
        <div data-role="fieldcontain" style="padding:10px 20px;">
            <h3>New Title:</h3>
            <input type="text" name="title" id="titleinput" value="{{event.title}}" data-theme="b" autocomplete="off">
            <br><br>
            <button type="submit" data-theme="b" data-icon="check">Save</button>
            <div class="input-error" id="titleinput-error">This field is required</div>
        </div>
    </form>
</div>

<!-- <div data-role="popup" id="editStartTime" data-overlay-theme="a" class="ui-content" data-theme="d" data-position-to="window">
	<form>
        <div style="padding:10px 20px;">
            <label for="fromdate"> Start Time Span </label> <input name="fromdate"
			data-mini="true" id="fromdate" type="date"
			placeholder="First applicable date" data-role="datebox"
			data-options='{"mode": "calbox", "useNewStyle": true, "overrideDateFormat":"%Y-%m-%d", "theme":"c", "themeHeader":"a", "themeDate":"c", "themeDateToday":"a", "useFocus":true}'>
        </div>
    </form>
</div>



<div data-role="popup" id="editEndTime" data-overlay-theme="a" class="ui-content" data-theme="d" data-position-to="window">
	<p>end time</p>
</div> -->

<div data-role="popup" id="editTimeOfDay" data-overlay-theme="a" class="ui-content" data-theme="d" data-position-to="window">
	<form action="{{post_url}}" method="post" data-ajax="false" id="timeOfDayform">
		<div id="checkboxes1" data-role="fieldcontain">
		<fieldset data-role="controlgroup" data-type="horizontal" id="fieldtype" data-mini="true">

			<input id="checkbox1" name="when" type="checkbox" value="morning">
			<label for="checkbox1">	Morning </label>
			 
			<input id="checkbox2" name="when"	type="checkbox" value="noon"> 
			<label for="checkbox2">	Noon </label>
			
			<input id="checkbox3" name="when" type="checkbox" value="evening"> 
			<label for="checkbox3">	Evening </label>
		</fieldset>
		<br>
		<button type="submit" data-theme="b" data-icon="check">Save</button>
        <div class="input-error" id="when-error">At least one time of day is required</div>
	</div>
    </form>
</div>

<div data-role="popup" id="editDuration" data-overlay-theme="a" class="ui-content" data-theme="d" data-position-to="window">
	<form action="{{post_url}}" method="post" data-ajax="false" id="durationform">
        <div style="padding:10px 20px;">
            <h3>New Duration (Hours):</h3>
			<input type="range" name="slider-step" id="slider-step" value="{{event.duration/60}}" min="0" max="5" step="0.5" />
            <button type="submit" data-theme="b" data-icon="check">Save</button>
        </div>
    </form>
</div>

<div data-role="popup" id="editDescription" data-overlay-theme="a" class="ui-content" data-theme="d" data-position-to="window">
	<form action="{{post_url}}" method="post" data-ajax="false" id="descriptionform">
        <div style="padding:10px 20px;">
            <h3>New Description:</h3>
			<textarea name="description" id="textarea-a">{{event.description}}</textarea>
            <button type="submit" data-theme="b" data-icon="check">Save</button>
        </div>
    </form>
</div>


<script type="text/javascript">
	$(document).ready(function() {
/* 		$("#guestinput").tokenInput("/api/autocomplete-contacts", {
			minChars : 3,
			theme : "facebook",
			hintText : "Email address or contact name",
			tokenDelimiter : ";",
			preventDuplicates : true,
		});
 */		
		$("#guestinput").change(function(){
			if ($(this).val() == "") {
				$(this).tokenInput("clear");
			}
		});
		
/* 		$("#fromdate").on("change", function(){
			var todate = $("#todate");
			var fromtime = $("#fromdate").datebox("getTheDate");
			var defDate = [fromtime.getFullYear(), fromtime.getMonth(), fromtime.getDate()];
			console.log(fromtime, defDate);
			todate.datebox({"defaultValue" : defDate});
			//todate.datebox("refresh");
		});
 */		
		$("#newevtform").submit(function(event){
			var succ = true;
			var first = null;
			
			function check_when()
			{
				var truth=$("#checkbox1").prop("checked") || $("#checkbox2").prop("checked") || $("#checkbox3").prop("checked");
				if (!truth) {
                    var msg = $("#when-error");
                    msg.show();
                    function onchg(){
                        msg.fadeOut();
                    }
                    $("#checkbox1").change(onchg);
                    $("#checkbox2").change(onchg);
                    $("#checkbox3").change(onchg);
				}
				return {truth:truth,obj:$("#checkbox1")};
			}
/* 			function check_endtime_gt_startime()
			{
				var truth=$("#fromdate").val() <= $("#todate").val()
				if (!truth) {
                    var msg = $("#todate-error2");
                    msg.show();
                    function onchg(){
                        msg.fadeOut();
                    }
                    $("#fromdate").change(onchg);
                    $("#todate").change(onchg);
				}
                return {truth:truth,obj:$("#todate")};
			}
 */			
			var to_validate = ["#titleinput", /* "#guestinput", "#fromdate", "#todate", */ 
			                   check_when/* , check_endtime_gt_startime */];
			
			for (var i in to_validate) {
				var selector = to_validate[i];
				if (typeof(selector) == "function") {
					res = selector();
					if (!res.truth) {
						succ = false;
                        if (!first) {
                            first = res.obj;
                        }
					}
				}
				else {
					var obj = $(selector);
		            if (!obj.val()) {
	                    succ = false;
		                if (!first) {
		                    first = obj;
		                }
		                var err = $(selector + "-error");
		                err.show();
		                obj.change((function(err){
		                	return (function(){
		                	    err.fadeOut();
		                	});
		                })(err));
		            }
				}
			}
			if (!succ) {
				event.preventDefault();
			}
			if (first) {
				first.focus();
			}
			return succ;
		});

	});
	
</script>


{% endblock %}

